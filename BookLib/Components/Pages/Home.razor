@page "/"
@inject IUserCurrentRepos UserCurrRepos
@inject IBookRepos Repository
@attribute [StreamRendering]
@using Microsoft.AspNetCore.Components

<div class="col-6">
    <div class="mb-3">
        <EditForm method="post" FormName="Search" Model="Book" OnValidSubmit="OnSearchClicked" autocomplete="off">
            <InputText @bind-Value="Book.Title"
                       placeholder="Type book title..."
                       class="form-control shadow-none" />
            <button type="submit" class="btn btn-primary mt-2">
                Enter
            </button>
        </EditForm>
        <EditForm FormName="SearchGenre" Model="Book" OnValidSubmit="OnGenreClicked" autocomplete="off">
            <div class="mb-3">
                <label for="genre" class="form-label"> Search By Genre</label>
                <InputSelect id="genre" @bind-Value="Book.Genre" class="form-control shadow-none">
                    <option value="">Select Genre:</option>
                    @foreach (var genre in Enum.GetValues(typeof(Genre)))
                    {
                        <option value="@genre">
                            @GenreDisplay.GetGenreName((Genre)genre).ToString()
                        </option>
                    }
                </InputSelect>
            </div>

            <button type="submit" class="btn btn-primary mt-2">
                Apply Genre
            </button>
        </EditForm>


    </div>
    @if (filteredBooks is null)
    {
        <div class="book-item">Loading books..., Please wait!</div>
    }
    else if (filteredBooks.Any())
    {
        @foreach (var book in filteredBooks)
        {
            <div class="book-item mb-2">
                <BookCard Book1="book" />
            </div>
        }
    }
    else
    {
        <div class="book-item">No books found.</div>
    }

</div>

@code {
    [SupplyParameterFromForm]
    public Book Book { get; set; } = new Book();
    private List<Book> filteredBooks = new();
    private string? searchText = "";
    private int? searchGenre = 0;

    protected override async Task OnInitializedAsync()
    {
        // Optionally load all books at first
        filteredBooks = await Repository.GetAllAsync();
    }
    // Called when the user types
    private async Task OnSearchClicked()
    {
        searchText = Book.Title;

        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredBooks = await Repository.GetAllAsync();
        }
        else
        {
            filteredBooks = await Repository.SearchByNameAsync(searchText);
        }
        StateHasChanged();
    }

    private async Task OnGenreClicked()
    {
        var genre = Book.Genre;

        filteredBooks = await Repository.SearchByGenreAsync(genre);

    }
}
